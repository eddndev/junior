# Sprint 3.5: Patr√≥n de Dialogs con Livewire

**Periodo:** 2025-10-23 - TBD

**Objetivo:** Refactorizar la arquitectura del sistema para usar dialogs (el-dialog) con componentes Livewire, eliminando navegaciones extensas y mejorando significativamente la UX del sistema.

---

## 1. Contexto y Problema

### Problema Actual:
- **Navegaci√≥n extensa:** Ver, editar y crear tareas/usuarios/√°reas requiere navegar a p√°ginas dedicadas
- **UX fragmentada:** El usuario pierde contexto al navegar entre p√°ginas
- **Performance:** Cada navegaci√≥n requiere cargar el layout completo
- **Estado:** Se pierde el estado de filtros, scroll position, etc.

### Soluci√≥n Propuesta:
Implementar un patr√≥n de **dialogs con Livewire** donde:
- Todas las operaciones CRUD se hacen en dialogs sin salir de la vista principal
- Los dialogs usan `el-dialog` como wrapper y Livewire components dentro
- Se mantiene contexto, filtros y estado de la p√°gina principal

### Restricci√≥n T√©cnica Cr√≠tica ‚ö†Ô∏è

**EL-DIALOG DEBE SER EL WRAPPER EXTERNO, NO PARTE DEL COMPONENTE LIVEWIRE**

‚ùå **INCORRECTO** (pierde estado al re-render):
```html
<!-- Livewire component -->
<div wire:id="abc123">
    <el-dialog> <!-- ‚Üê Se re-renderiza con el componente -->
        <dialog>
            <h1 wire:model="title">{{ $title }}</h1>
        </dialog>
    </el-dialog>
</div>
```

‚úÖ **CORRECTO** (el-dialog fuera, no se re-renderiza):
```html
<!-- Wrapper est√°tico (NO se re-renderiza) -->
<el-dialog>
    <dialog id="task-dialog">
        <!-- Livewire component DENTRO (se re-renderiza) -->
        @livewire('tasks.task-dialog', ['taskId' => $taskId])
    </dialog>
</el-dialog>
```

**Raz√≥n:** Cuando Livewire re-renderiza, reemplaza el DOM del componente. Si `el-dialog` est√° dentro, pierde su estado interno (abierto/cerrado), y aunque l√≥gicamente est√© "abierto", el DOM lo trata como cerrado, bloqueando la UI.

---

## 2. Arquitectura del Patr√≥n

### 2.1 Estructura de Componentes

**Patr√≥n General:**
```
Vista Principal (Blade)
‚îú‚îÄ‚îÄ Tabla/Lista de items
‚îú‚îÄ‚îÄ Bot√≥n "Nuevo Item" ‚Üí Dispara dialog
‚îî‚îÄ‚îÄ Dialog Wrapper (el-dialog) - EST√ÅTICO
    ‚îî‚îÄ‚îÄ Livewire Component (din√°mico)
        ‚îú‚îÄ‚îÄ Formulario
        ‚îú‚îÄ‚îÄ Validaci√≥n inline
        ‚îî‚îÄ‚îÄ Acciones (Guardar, Cancelar)
```

**Comunicaci√≥n:**
```
Vista Principal (Alpine.js)
    ‚Üì dispatch('open-dialog', { id: 123 })
Dialog Wrapper (el-dialog)
    ‚Üì abre dialog
Livewire Component
    ‚Üì carga datos y renderiza
    ‚Üì usuario edita
    ‚Üì wire:submit / wire:click
    ‚Üì valida y guarda
    ‚Üì $dispatch('task-updated')
Vista Principal (Alpine.js)
    ‚Üì escucha evento
    ‚Üì refresca tabla/lista
    ‚Üì cierra dialog
```

### 2.2 Convenciones de Nombres

**Componentes Livewire:**
- `app/Livewire/Tasks/TaskDialog.php`
- `app/Livewire/Tasks/CreateTaskDialog.php`
- `app/Livewire/Areas/AreaDialog.php`
- `app/Livewire/Users/UserDialog.php`

**Vistas:**
- `resources/views/livewire/tasks/task-dialog.blade.php`
- `resources/views/livewire/tasks/create-task-dialog.blade.php`

**Dialogs (wrappers):**
- `resources/views/dialogs/task-dialog.blade.php`
- `resources/views/dialogs/create-task-dialog.blade.php`

**Eventos:**
- `open-task-dialog` - Abrir dialog de tarea existente
- `open-create-task-dialog` - Abrir dialog de creaci√≥n
- `task-updated` - Tarea actualizada
- `task-created` - Tarea creada
- `close-dialog` - Cerrar dialog

---

## 3. Implementaci√≥n por Fases

### FASE 1: Infraestructura Base (Sprint 3.5)

**Objetivo:** Establecer el patr√≥n y crear componentes base reutilizables.

#### 3.1.1 Crear Trait Reutilizable para Dialogs

**Archivo:** `app/Livewire/Traits/WithDialog.php`

```php
<?php

namespace App\Livewire\Traits;

trait WithDialog
{
    public bool $isOpen = false;

    public function openDialog()
    {
        $this->isOpen = true;
    }

    public function closeDialog()
    {
        $this->isOpen = false;
        $this->reset(); // Reset component state
    }

    public function closeAndRefresh()
    {
        $this->closeDialog();
        $this->dispatch('refresh-list'); // Notify parent to refresh
    }
}
```

#### 3.1.2 Crear Componente Base Dialog

**Archivo:** `resources/views/components/dialog-wrapper.blade.php`

```blade
@props(['id', 'maxWidth' => '2xl'])

@php
$maxWidthClasses = [
    'sm' => 'max-w-sm',
    'md' => 'max-w-md',
    'lg' => 'max-w-lg',
    'xl' => 'max-w-xl',
    '2xl' => 'max-w-2xl',
    '3xl' => 'max-w-3xl',
    '4xl' => 'max-w-4xl',
];
@endphp

<el-dialog>
    <dialog {{ $attributes->merge(['id' => $id]) }}
            class="fixed inset-0 size-auto max-h-none max-w-none overflow-hidden bg-transparent not-open:hidden backdrop:bg-transparent">

        <el-dialog-backdrop class="absolute inset-0 bg-neutral-500/75 dark:bg-neutral-950/75 transition-opacity duration-500 ease-in-out data-closed:opacity-0"></el-dialog-backdrop>

        <div tabindex="0" class="absolute inset-0 pl-10 focus:outline-none sm:pl-16">
            <el-dialog-panel class="ml-auto block size-full {{ $maxWidthClasses[$maxWidth] }} transform transition duration-500 ease-in-out data-closed:translate-x-full sm:duration-700">
                <div class="flex h-full flex-col overflow-y-auto bg-white dark:bg-neutral-900 shadow-xl">
                    {{ $slot }}
                </div>
            </el-dialog-panel>
        </div>
    </dialog>
</el-dialog>
```

#### 3.1.3 Crear Sistema de Eventos Global

**Archivo:** `resources/js/dialog-system.js`

```javascript
// Sistema global de manejo de dialogs
window.DialogSystem = {
    open(dialogId) {
        const dialog = document.getElementById(dialogId);
        if (dialog && typeof dialog.showModal === 'function') {
            dialog.showModal();
        }
    },

    close(dialogId) {
        const dialog = document.getElementById(dialogId);
        if (dialog && typeof dialog.close === 'function') {
            dialog.close();
        }
    }
};

// Listeners globales para eventos Livewire
document.addEventListener('livewire:init', () => {
    // Escuchar evento de abrir dialog
    Livewire.on('open-dialog', (data) => {
        DialogSystem.open(data.dialogId);
    });

    // Escuchar evento de cerrar dialog
    Livewire.on('close-dialog', (data) => {
        DialogSystem.close(data.dialogId);
    });
});
```

---

### FASE 2: Implementaci√≥n para Tareas (Sprint 3.5)

#### 3.2.1 Crear Componentes Livewire para Tareas

##### TaskDetailDialog (Ver/Editar)

**Archivo:** `app/Livewire/Tasks/TaskDetailDialog.php`

```php
<?php

namespace App\Livewire\Tasks;

use App\Models\Task;
use Livewire\Component;
use Livewire\WithFileUploads;

class TaskDetailDialog extends Component
{
    use WithFileUploads;

    public ?int $taskId = null;
    public ?Task $task = null;

    // Form fields
    public string $title = '';
    public string $description = '';
    public string $priority = 'medium';
    public string $status = 'pending';
    public ?string $dueDate = null;

    // Edit mode
    public bool $editMode = false;
    public bool $editingTitle = false;
    public bool $editingDescription = false;

    // Listeners
    protected $listeners = [
        'loadTask' => 'load',
    ];

    public function mount(?int $taskId = null)
    {
        if ($taskId) {
            $this->load($taskId);
        }
    }

    public function load(int $taskId)
    {
        $this->taskId = $taskId;
        $this->task = Task::with(['area', 'assignments.user', 'subtasks', 'media'])
            ->findOrFail($taskId);

        $this->authorize('view', $this->task);

        $this->title = $this->task->title;
        $this->description = $this->task->description ?? '';
        $this->priority = $this->task->priority;
        $this->status = $this->task->status;
        $this->dueDate = $this->task->due_date?->format('Y-m-d');
    }

    public function startEditTitle()
    {
        $this->editingTitle = true;
    }

    public function saveTitle()
    {
        $this->validate([
            'title' => 'required|string|min:3|max:255',
        ]);

        $this->task->update(['title' => $this->title]);
        $this->editingTitle = false;

        $this->dispatch('task-updated', taskId: $this->taskId);
        $this->dispatch('show-toast', message: 'T√≠tulo actualizado exitosamente', type: 'success');
    }

    public function cancelEditTitle()
    {
        $this->title = $this->task->title;
        $this->editingTitle = false;
    }

    public function startEditDescription()
    {
        $this->editingDescription = true;
    }

    public function saveDescription()
    {
        $this->validate([
            'description' => 'nullable|string|max:5000',
        ]);

        $this->task->update(['description' => $this->description]);
        $this->editingDescription = false;

        $this->dispatch('task-updated', taskId: $this->taskId);
        $this->dispatch('show-toast', message: 'Descripci√≥n actualizada exitosamente', type: 'success');
    }

    public function cancelEditDescription()
    {
        $this->description = $this->task->description ?? '';
        $this->editingDescription = false;
    }

    public function render()
    {
        return view('livewire.tasks.task-detail-dialog');
    }
}
```

##### CreateTaskDialog

**Archivo:** `app/Livewire/Tasks/CreateTaskDialog.php`

```php
<?php

namespace App\Livewire\Tasks;

use App\Models\Task;
use App\Models\Area;
use App\Models\User;
use Livewire\Component;
use Livewire\WithFileUploads;

class CreateTaskDialog extends Component
{
    use WithFileUploads;

    // Form fields
    public string $title = '';
    public string $description = '';
    public int $areaId;
    public array $assignedUsers = [];
    public string $priority = 'medium';
    public string $status = 'pending';
    public ?string $dueDate = null;
    public array $attachments = [];

    // Data for dropdowns
    public $areas = [];
    public $users = [];

    protected $rules = [
        'title' => 'required|string|min:3|max:255',
        'description' => 'nullable|string|max:5000',
        'areaId' => 'required|exists:areas,id',
        'assignedUsers' => 'nullable|array',
        'assignedUsers.*' => 'exists:users,id',
        'priority' => 'required|in:low,medium,high,critical',
        'status' => 'required|in:pending,in_progress,completed,cancelled',
        'dueDate' => 'nullable|date|after_or_equal:today',
        'attachments.*' => 'nullable|file|max:10240',
    ];

    public function mount()
    {
        $user = auth()->user();

        $this->areas = $user->hasRole('super-admin')
            ? Area::active()->orderBy('name')->get()
            : $user->areas()->where('is_active', true)->orderBy('name')->get();

        $this->users = User::where('is_active', true)->orderBy('name')->get();

        // Set default area if only one
        if ($this->areas->count() === 1) {
            $this->areaId = $this->areas->first()->id;
        }
    }

    public function save()
    {
        $this->validate();

        $this->authorize('create', Task::class);

        $task = Task::create([
            'title' => $this->title,
            'description' => $this->description,
            'area_id' => $this->areaId,
            'priority' => $this->priority,
            'status' => $this->status,
            'due_date' => $this->dueDate,
        ]);

        // Assign users
        if (!empty($this->assignedUsers)) {
            foreach ($this->assignedUsers as $userId) {
                TaskAssignment::create([
                    'assignable_type' => Task::class,
                    'assignable_id' => $task->id,
                    'user_id' => $userId,
                    'assigned_at' => now(),
                ]);
            }
        }

        // Handle file attachments
        if (!empty($this->attachments)) {
            foreach ($this->attachments as $file) {
                $task->addMedia($file)->toMediaCollection('attachments');
            }
        }

        $this->dispatch('task-created', taskId: $task->id);
        $this->dispatch('close-dialog', dialogId: 'create-task-dialog');
        $this->dispatch('show-toast', message: 'Tarea creada exitosamente', type: 'success');

        $this->reset();
    }

    public function cancel()
    {
        $this->dispatch('close-dialog', dialogId: 'create-task-dialog');
        $this->reset();
    }

    public function render()
    {
        return view('livewire.tasks.create-task-dialog');
    }
}
```

#### 3.2.2 Crear Vistas Livewire

##### TaskDetailDialog Blade

**Archivo:** `resources/views/livewire/tasks/task-detail-dialog.blade.php`

```blade
<div>
    @if($task)
        {{-- Header --}}
        <div class="sticky top-0 z-10 border-b border-neutral-200 bg-white px-6 py-4 dark:border-neutral-700 dark:bg-neutral-900">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    {{-- Title Editor --}}
                    <div class="mb-2">
                        @if($editingTitle)
                            <div class="flex items-center gap-2">
                                <input type="text"
                                       wire:model="title"
                                       wire:keydown.enter="saveTitle"
                                       wire:keydown.escape="cancelEditTitle"
                                       class="flex-1 rounded-md border-neutral-300 text-lg font-semibold focus:border-primary-500 focus:ring-primary-500 dark:border-neutral-600 dark:bg-neutral-800 dark:text-white"
                                       placeholder="T√≠tulo de la tarea">
                                <button wire:click="saveTitle"
                                        class="rounded-md bg-primary-600 px-2 py-1 text-sm font-semibold text-white hover:bg-primary-500">
                                    Guardar
                                </button>
                                <button wire:click="cancelEditTitle"
                                        class="rounded-md px-2 py-1 text-sm font-semibold text-neutral-700 hover:bg-neutral-100 dark:text-neutral-300 dark:hover:bg-neutral-700">
                                    Cancelar
                                </button>
                            </div>
                            @error('title')
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ $message }}</p>
                            @enderror
                        @else
                            <div class="flex items-center gap-2">
                                <h2 class="text-lg font-semibold text-neutral-900 dark:text-white">{{ $title }}</h2>
                                <button wire:click="startEditTitle"
                                        class="text-neutral-400 hover:text-neutral-600 dark:hover:text-neutral-300"
                                        title="Editar t√≠tulo">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                            </div>
                        @endif
                    </div>

                    {{-- Status and Priority Badges --}}
                    <div class="flex items-center gap-2">
                        <x-tasks.task-status-badge :status="$task->status" />
                        {{-- Priority badge component --}}
                    </div>

                    <p class="mt-1 text-sm text-neutral-500 dark:text-neutral-400">
                        {{ $task->area->name }}
                    </p>
                </div>

                {{-- Close Button --}}
                <button type="button"
                        command="close"
                        commandfor="task-detail-dialog"
                        class="ml-3 text-neutral-400 hover:text-neutral-500 dark:hover:text-neutral-300">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="size-6">
                        <path d="M6 18 18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </button>
            </div>
        </div>

        {{-- Content --}}
        <div class="flex-1 overflow-y-auto px-6 py-6">
            {{-- Description Editor --}}
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-semibold text-neutral-900 dark:text-white">Descripci√≥n</h3>
                    @if(!$editingDescription)
                        <button wire:click="startEditDescription"
                                class="text-neutral-400 hover:text-neutral-600 dark:hover:text-neutral-300"
                                title="Editar descripci√≥n">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                    @endif
                </div>

                @if($editingDescription)
                    <div>
                        <textarea wire:model="description"
                                  wire:keydown.escape="cancelEditDescription"
                                  rows="6"
                                  class="w-full rounded-md border-neutral-300 focus:border-primary-500 focus:ring-primary-500 dark:border-neutral-600 dark:bg-neutral-800 dark:text-white"
                                  placeholder="Descripci√≥n de la tarea"></textarea>
                        <div class="mt-2 flex items-center gap-2">
                            <button wire:click="saveDescription"
                                    class="rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white hover:bg-primary-500">
                                Guardar
                            </button>
                            <button wire:click="cancelEditDescription"
                                    class="rounded-md px-3 py-2 text-sm font-semibold text-neutral-700 hover:bg-neutral-100 dark:text-neutral-300 dark:hover:bg-neutral-700">
                                Cancelar
                            </button>
                        </div>
                        @error('description')
                            <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ $message }}</p>
                        @enderror
                    </div>
                @else
                    <div class="prose prose-sm max-w-none dark:prose-invert text-neutral-700 dark:text-neutral-300">
                        {!! $description ? nl2br(e($description)) : '<p class="text-neutral-500 dark:text-neutral-400">Sin descripci√≥n</p>' !!}
                    </div>
                @endif
            </div>

            {{-- Assigned Users --}}
            <div class="mb-6">
                <h3 class="text-sm font-semibold text-neutral-900 dark:text-white mb-3">Asignados</h3>
                @if($task->assignments->count() > 0)
                    <div class="space-y-2">
                        @foreach($task->assignments as $assignment)
                            <div class="flex items-center gap-3">
                                <div class="flex h-8 w-8 items-center justify-center rounded-full bg-primary-100 text-sm font-medium text-primary-700 dark:bg-primary-900 dark:text-primary-300">
                                    {{ substr($assignment->user->name, 0, 1) }}
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-neutral-900 dark:text-white">{{ $assignment->user->name }}</p>
                                    <p class="text-xs text-neutral-500 dark:text-neutral-400">{{ $assignment->user->email }}</p>
                                </div>
                            </div>
                        @endforeach
                    </div>
                @else
                    <p class="text-sm text-neutral-500 dark:text-neutral-400">Sin asignaciones</p>
                @endif
            </div>

            {{-- Subtasks --}}
            @if($task->subtasks->count() > 0)
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-neutral-900 dark:text-white mb-3">Subtareas</h3>
                    <div class="space-y-2">
                        @foreach($task->subtasks as $subtask)
                            <div class="flex items-center gap-2">
                                <input type="checkbox"
                                       {{ $subtask->status === 'completed' ? 'checked' : '' }}
                                       class="rounded border-neutral-300 text-primary-600 focus:ring-primary-500">
                                <span class="text-sm {{ $subtask->status === 'completed' ? 'line-through text-neutral-500' : 'text-neutral-900 dark:text-white' }}">
                                    {{ $subtask->title }}
                                </span>
                            </div>
                        @endforeach
                    </div>
                </div>
            @endif

            {{-- Metadata --}}
            <div class="pt-6 border-t border-neutral-200 dark:border-neutral-700">
                <dl class="space-y-3 text-sm">
                    <div>
                        <dt class="font-medium text-neutral-500 dark:text-neutral-400">Creada</dt>
                        <dd class="mt-1 text-neutral-900 dark:text-white">{{ $task->created_at->diffForHumans() }}</dd>
                    </div>
                    @if($task->completed_at)
                        <div>
                            <dt class="font-medium text-neutral-500 dark:text-neutral-400">Completada</dt>
                            <dd class="mt-1 text-neutral-900 dark:text-white">{{ $task->completed_at->diffForHumans() }}</dd>
                        </div>
                    @endif
                </dl>
            </div>
        </div>

        {{-- Footer Actions --}}
        <div class="sticky bottom-0 border-t border-neutral-200 bg-neutral-50 px-6 py-4 dark:border-neutral-700 dark:bg-neutral-800">
            <div class="flex justify-between items-center">
                <button type="button"
                        command="close"
                        commandfor="task-detail-dialog"
                        class="rounded-md px-3 py-2 text-sm font-semibold text-neutral-900 hover:bg-neutral-100 dark:text-white dark:hover:bg-neutral-700">
                    Cerrar
                </button>
            </div>
        </div>
    @else
        <div class="flex items-center justify-center h-full">
            <div class="text-center">
                <svg class="mx-auto h-12 w-12 text-neutral-400 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-sm text-neutral-500 dark:text-neutral-400">Cargando tarea...</p>
            </div>
        </div>
    @endif
</div>
```

#### 3.2.3 Integrar en Vista Principal

**Archivo:** `resources/views/tasks/kanban.blade.php` (modificaciones)

```blade
{{-- Al final del archivo, antes de cerrar el layout --}}

{{-- Dialog Wrapper (FUERA de Livewire) --}}
<x-dialog-wrapper id="task-detail-dialog" max-width="2xl">
    @livewire('tasks.task-detail-dialog')
</x-dialog-wrapper>

{{-- Dialog de Creaci√≥n --}}
<x-dialog-wrapper id="create-task-dialog" max-width="3xl">
    @livewire('tasks.create-task-dialog')
</x-dialog-wrapper>

@push('scripts')
<script>
    // Listener para abrir dialog de detalle
    document.addEventListener('livewire:init', () => {
        Livewire.on('task-updated', (data) => {
            // Refrescar la card del Kanban
            location.reload(); // O implementar refresh m√°s granular
        });

        Livewire.on('task-created', (data) => {
            // Refrescar el Kanban
            location.reload();
        });
    });

    // Funci√≥n para abrir dialog desde cards
    function openTaskDetail(taskId) {
        Livewire.dispatch('loadTask', { taskId: taskId });
        DialogSystem.open('task-detail-dialog');
    }

    function openCreateTaskDialog() {
        DialogSystem.open('create-task-dialog');
    }
</script>
@endpush
```

---

### FASE 3: Extender a Otros M√≥dulos (Sprint 4)

#### 3.3.1 √Åreas (CRUD en dialogs)

**Componentes a crear:**
- `app/Livewire/Areas/AreaDialog.php` - Ver/Editar √°rea
- `app/Livewire/Areas/CreateAreaDialog.php` - Crear √°rea
- `app/Livewire/Areas/DeleteAreaDialog.php` - Confirmar eliminaci√≥n

**Vistas:**
- `resources/views/livewire/areas/area-dialog.blade.php`
- `resources/views/livewire/areas/create-area-dialog.blade.php`
- `resources/views/livewire/areas/delete-area-dialog.blade.php`

**Integraci√≥n:**
- Modificar `areas/index.blade.php` para usar dialogs
- Eliminar `areas/show.blade.php`, `areas/create.blade.php`, `areas/edit.blade.php`

#### 3.3.2 Usuarios (CRUD en dialogs)

**Componentes a crear:**
- `app/Livewire/Users/UserDialog.php` - Ver/Editar usuario
- `app/Livewire/Users/CreateUserDialog.php` - Crear usuario
- `app/Livewire/Users/AssignRolesDialog.php` - Asignar roles

**Vistas:**
- `resources/views/livewire/users/user-dialog.blade.php`
- `resources/views/livewire/users/create-user-dialog.blade.php`
- `resources/views/livewire/users/assign-roles-dialog.blade.php`

**Integraci√≥n:**
- Modificar `users/index.blade.php` para usar dialogs
- Eliminar vistas dedicadas (show, create, edit)

---

## 4. Componentes Reutilizables

### 4.1 Dialog Header Component

**Archivo:** `resources/views/components/dialog-header.blade.php`

```blade
@props(['title', 'subtitle' => null])

<div class="sticky top-0 z-10 border-b border-neutral-200 bg-white px-6 py-4 dark:border-neutral-700 dark:bg-neutral-900">
    <div class="flex items-start justify-between">
        <div class="flex-1">
            <h2 class="text-lg font-semibold text-neutral-900 dark:text-white">{{ $title }}</h2>
            @if($subtitle)
                <p class="mt-1 text-sm text-neutral-500 dark:text-neutral-400">{{ $subtitle }}</p>
            @endif
        </div>
        <button type="button"
                {{ $attributes->merge(['command' => 'close']) }}
                class="ml-3 text-neutral-400 hover:text-neutral-500 dark:hover:text-neutral-300">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="size-6">
                <path d="M6 18 18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
        </button>
    </div>
</div>
```

### 4.2 Dialog Footer Component

**Archivo:** `resources/views/components/dialog-footer.blade.php`

```blade
@props(['cancelText' => 'Cancelar', 'submitText' => 'Guardar', 'submitAction' => null])

<div class="sticky bottom-0 border-t border-neutral-200 bg-neutral-50 px-6 py-4 dark:border-neutral-700 dark:bg-neutral-800">
    <div class="flex justify-end gap-3">
        <button type="button"
                command="close"
                {{ $attributes->whereStartsWith('commandfor') }}
                class="rounded-md px-4 py-2 text-sm font-semibold text-neutral-700 hover:bg-neutral-100 dark:text-neutral-300 dark:hover:bg-neutral-700">
            {{ $cancelText }}
        </button>
        @if($submitAction)
            <button type="button"
                    wire:click="{{ $submitAction }}"
                    class="rounded-md bg-primary-600 px-4 py-2 text-sm font-semibold text-white hover:bg-primary-500 dark:bg-primary-500 dark:hover:bg-primary-400">
                {{ $submitText }}
            </button>
        @else
            {{ $slot }}
        @endif
    </div>
</div>
```

---

## 5. Testing del Patr√≥n

### 5.1 Test de Componente Livewire

**Archivo:** `tests/Feature/Livewire/Tasks/TaskDetailDialogTest.php`

```php
<?php

namespace Tests\Feature\Livewire\Tasks;

use App\Livewire\Tasks\TaskDetailDialog;
use App\Models\Task;
use App\Models\User;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Livewire\Livewire;
use Tests\TestCase;

class TaskDetailDialogTest extends TestCase
{
    use RefreshDatabase;

    public function test_can_load_task()
    {
        $user = User::factory()->create();
        $task = Task::factory()->create();

        Livewire::actingAs($user)
            ->test(TaskDetailDialog::class)
            ->call('load', $task->id)
            ->assertSet('taskId', $task->id)
            ->assertSet('title', $task->title);
    }

    public function test_can_edit_title()
    {
        $user = User::factory()->create();
        $task = Task::factory()->create(['title' => 'Old Title']);

        Livewire::actingAs($user)
            ->test(TaskDetailDialog::class)
            ->call('load', $task->id)
            ->set('title', 'New Title')
            ->call('saveTitle')
            ->assertHasNoErrors();

        $this->assertDatabaseHas('tasks', [
            'id' => $task->id,
            'title' => 'New Title',
        ]);
    }

    public function test_validates_title_length()
    {
        $user = User::factory()->create();
        $task = Task::factory()->create();

        Livewire::actingAs($user)
            ->test(TaskDetailDialog::class)
            ->call('load', $task->id)
            ->set('title', 'AB') // Too short
            ->call('saveTitle')
            ->assertHasErrors(['title']);
    }
}
```

---

## 6. Migraci√≥n y Limpieza

### 6.1 Rutas a Eliminar

Despu√©s de migrar completamente, eliminar de `routes/web.php`:

```php
// ELIMINAR (reemplazado por dialogs):
Route::get('tasks/{task}', [TaskController::class, 'show'])->name('tasks.show');
Route::get('tasks/create', [TaskController::class, 'create'])->name('tasks.create');
Route::get('tasks/{task}/edit', [TaskController::class, 'edit'])->name('tasks.edit');

Route::get('areas/{area}', [AreaController::class, 'show'])->name('areas.show');
Route::get('areas/create', [AreaController::class, 'create'])->name('areas.create');
Route::get('areas/{area}/edit', [AreaController::class, 'edit'])->name('areas.edit');

// MANTENER (endpoints API para Livewire):
Route::patch('tasks/{task}', [TaskController::class, 'update'])->name('tasks.update');
Route::post('tasks', [TaskController::class, 'store'])->name('tasks.store');
Route::delete('tasks/{task}', [TaskController::class, 'destroy'])->name('tasks.destroy');
```

### 6.2 Vistas a Eliminar

```
resources/views/tasks/
‚îú‚îÄ‚îÄ show.blade.php ‚ùå (reemplazado por dialog)
‚îú‚îÄ‚îÄ create.blade.php ‚ùå (reemplazado por dialog)
‚îî‚îÄ‚îÄ edit.blade.php ‚ùå (reemplazado por dialog)

resources/views/areas/
‚îú‚îÄ‚îÄ show.blade.php ‚ùå
‚îú‚îÄ‚îÄ create.blade.php ‚ùå
‚îî‚îÄ‚îÄ edit.blade.php ‚ùå

resources/views/users/
‚îú‚îÄ‚îÄ show.blade.php ‚ùå
‚îú‚îÄ‚îÄ create.blade.php ‚ùå
‚îî‚îÄ‚îÄ edit.blade.php ‚ùå
```

---

## 7. Checklist de Implementaci√≥n

### FASE 1: Infraestructura (Sprint 3.5)
- [ ] Instalar Livewire (`composer require livewire/livewire`)
- [ ] Crear trait `WithDialog`
- [ ] Crear componente `dialog-wrapper.blade.php`
- [ ] Crear `dialog-system.js`
- [ ] Crear `dialog-header.blade.php` y `dialog-footer.blade.php`
- [ ] Configurar Livewire en `app.css` y `app.js`

### FASE 2: Tareas (Sprint 3.5)
- [ ] Crear `TaskDetailDialog` component
- [ ] Crear `CreateTaskDialog` component
- [ ] Crear vistas Livewire correspondientes
- [ ] Integrar en `kanban.blade.php`
- [ ] Integrar en `index.blade.php`
- [ ] Eliminar `_detail-dialog.blade.php` (AJAX antigua)
- [ ] Probar edici√≥n inline de t√≠tulo/descripci√≥n
- [ ] Probar creaci√≥n de tareas desde Kanban
- [ ] Escribir tests Livewire

### FASE 3: √Åreas (Sprint 4)
- [ ] Crear `AreaDialog` component
- [ ] Crear `CreateAreaDialog` component
- [ ] Integrar en `areas/index.blade.php`
- [ ] Eliminar vistas dedicadas (show, create, edit)
- [ ] Escribir tests

### FASE 4: Usuarios (Sprint 4)
- [ ] Crear `UserDialog` component
- [ ] Crear `CreateUserDialog` component
- [ ] Crear `AssignRolesDialog` component
- [ ] Integrar en `users/index.blade.php`
- [ ] Eliminar vistas dedicadas
- [ ] Escribir tests

### FASE 5: Limpieza y Optimizaci√≥n
- [ ] Eliminar rutas no utilizadas
- [ ] Eliminar controladores obsoletos (m√©todos show, create, edit)
- [ ] Documentar el patr√≥n en README
- [ ] Crear gu√≠a para desarrolladores
- [ ] Optimizar carga de Livewire (lazy loading)

---

## 8. Consideraciones de Performance

### 8.1 Lazy Loading de Dialogs

```php
// Solo cargar el componente cuando se abre el dialog
@livewire('tasks.task-detail-dialog', ['taskId' => null], key('task-detail'))
```

### 8.2 Cache de Queries

```php
// En TaskDetailDialog
public function load(int $taskId)
{
    $this->task = Cache::remember(
        "task.{$taskId}",
        now()->addMinutes(5),
        fn() => Task::with(['area', 'assignments.user', 'subtasks', 'media'])
            ->findOrFail($taskId)
    );
}
```

### 8.3 Debouncing en Inputs

```blade
<input type="text"
       wire:model.debounce.500ms="title"
       placeholder="Buscar...">
```

---

## 9. Beneficios del Patr√≥n

### ‚úÖ UX Mejorada
- ‚ùå Antes: Click ‚Üí Navegar ‚Üí Esperar carga ‚Üí Editar ‚Üí Volver (perdiendo contexto)
- ‚úÖ Ahora: Click ‚Üí Dialog ‚Üí Editar ‚Üí Cerrar (manteniendo contexto)

### ‚úÖ Performance
- Menos cargas de p√°gina completa
- JavaScript m√≠nimo (Livewire maneja comunicaci√≥n)
- Estado de filtros y scroll persiste

### ‚úÖ Mantenibilidad
- Componentes Livewire reutilizables
- Validaci√≥n centralizada
- Menos JavaScript custom (menos bugs)

### ‚úÖ Desarrollo m√°s R√°pido
- CRUD completo en ~30 minutos por m√≥dulo
- Patr√≥n replicable
- Tests m√°s f√°ciles

---

## 10. Pr√≥ximos Pasos

1. **Implementar Fase 1** (infraestructura) ‚Üí 2 horas
2. **Implementar Fase 2** (tareas) ‚Üí 4 horas
3. **Testing end-to-end** ‚Üí 1 hora
4. **Code review y ajustes** ‚Üí 1 hora
5. **Documentaci√≥n** ‚Üí 1 hora

**Tiempo estimado Sprint 3.5:** 9 horas

---

**Estado:** üìã PLANIFICADO

**Prioridad:** ‚ö° ALTA (mejora cr√≠tica de UX)

**Bloqueante:** No (puede convivir con c√≥digo actual temporalmente)
